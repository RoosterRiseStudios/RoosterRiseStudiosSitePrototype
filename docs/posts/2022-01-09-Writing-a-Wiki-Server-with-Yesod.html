<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta charset="utf-8">
    <meta http-equiv="x-ua-compatible" content="ie=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>lambda is not a four letter word - Writing a Wiki Server with Yesod</title>
    <link rel="stylesheet" type="text/css" href="../css/composeconference.css" />
    <link rel="alternate" type="application/atom+xml" href="../atom.xml" />
    <link rel="alternate" type="application/rss+xml" href="../rss.xml" />

    <!-- MATH JAX-->
    <script type="text/javascript" src="../static/mathjax/tex-mml-chtml.js"></script>

    <!-- favicon stuff-->
    <link rel="apple-touch-icon" sizes="57x57" href="../apple-icon-57x57.png">
    <link rel="apple-touch-icon" sizes="60x60" href="../apple-icon-60x60.png">
    <link rel="apple-touch-icon" sizes="72x72" href="../apple-icon-72x72.png">
    <link rel="apple-touch-icon" sizes="76x76" href="../apple-icon-76x76.png">
    <link rel="apple-touch-icon" sizes="114x114" href="../apple-icon-114x114.png">
    <link rel="apple-touch-icon" sizes="120x120" href="../apple-icon-120x120.png">
    <link rel="apple-touch-icon" sizes="144x144" href="../apple-icon-144x144.png">
    <link rel="apple-touch-icon" sizes="152x152" href="../apple-icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="../apple-icon-180x180.png">
    <link rel="icon" type="image/png" sizes="192x192" href="../android-icon-192x192.png">
    <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="96x96" href="../favicon-96x96.png">
    <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
    <link rel="manifest" href="../manifest.json">
    <meta name="msapplication-TileColor" content="#ffffff">
    <meta name="msapplication-TileImage" content="/ms-icon-144x144.png">
    <meta name="theme-color" content="#ffffff">
</head>
<body>

<header>
    <div class="heading">
        <div class="logo">
            <div style="float: left">
                <img src="../img/lambda-150.png" alt="\" height="40px" valign="bottom" />
            </div>
            <div>
                <a href="../">&nbsp;lambda is not a four letter word</a>
            </div>
        </div>
        <nav>
            <a href="../">home</a> | <a href="../about.html">about</a> | <a href="https://github.com/thma"><img valign="middle" src="../img/GitHub-Mark-32px.png" height="20px" alt="GitHub"></a>
        </nav>
    </div>
</header>

<main class="markdown-body" role="main">
    <h1>Writing a Wiki Server with Yesod</h1>
    <div class="info">
    <em>Posted on January  9, 2022
    
        by Thomas Mahler
    </em><br /><br />
</div>

<a href="https://github.com/thma/HsWiki/actions"><img src="https://github.com/thma/HsWiki/workflows/Haskell%20CI/badge.svg" alt="Actions Status" /></a> <a href="https://github.com/thma/HsWiki"><img src="https://thma.github.io/img/forkme.png" height="20"></a>
</p>
<h2 id="abstract">Abstract</h2>
<p>In this blog post I’m presenting an implementation of a Wiki System in the spirit of the legendary <a href="http://wiki.c2.com/">C2-Wiki</a> - written in Haskell with the <a href="https://www.yesodweb.com/">Yesod</a> framework.</p>
<p>There will also be some nice add-ons like a graphical representation of the page links.</p>
<h2 id="introduction">Introduction</h2>
<blockquote>
<p>The WikiWikiWeb is the first wiki, or user-editable website. It was launched on 25 March 1995 by its inventor, programmer Ward Cunningham, to accompany the Portland Pattern Repository website discussing software design patterns.</p>
<p><a href="https://en.wikipedia.org/wiki/WikiWikiWeb">cited from Wikipedia</a></p>
</blockquote>
<p>The <a href="http://wiki.c2.com/">WikiWikiWeb</a> was the earliest incarnation of a collaborative hypertext platform on the internet. It started with a small set of features which proved to provide the essential tools required to create a large content base with a dense hyperlink structure. Editing and creating new pages was extremely simple which fostered free contributions and a high frequency of interactions between participants.</p>
<p>The most prominent features are:</p>
<ul>
<li>A tiny markup language allows basic adjustments of typography and layout.</li>
<li>All content is rendered as HTML and thus allow easy navigation with any web browser.</li>
<li>An inplace editor allows adhoc creation and editing of pages. On saving edited content, the page switches back to display mode, which renders the markup as HTML.</li>
<li>WikiWords, that is Text in PascalCase or <a href="https://en.wikipedia.org/wiki/Camel_case">Upper Camel Case</a> are interpreted as hyperlinks. If such a hyperlink does not link to an existing page, the editor is opened for creating a new page. This mechanism allows to create hyperlinked content in a very fast manner.</li>
<li>Clicking on a Page Title will display a list of all references to the current page. This allows to identify related topics and also to organize semantic networks by creating category pages that just keep links to all pages in the category <a href="http://wiki.c2.com/?CategoryCategory">CategoryCategory</a></li>
<li>The RecentChanges page shows the latest creation and edits to pages and thus makes it easy to identify hot topics</li>
<li>There is a full text search available.</li>
</ul>
<p>In the following I’m going to explain how I implemented each of those features.</p>
<h2 id="a-simple-markup-language-just-use-markdown">A simple markup language: Just use Markdown</h2>
<p>The original WikiWikiWeb markup language provided basic syntax for layouting text content. Modern markup languages like Markdown are a more convenient to use, provide much more features and are already widely used. So I’m going to use Markdown instead of the original markup language.</p>
<h2 id="rendering-content-as-html">Rendering content as HTML</h2>
<p>Yesod comes with a set of <a href="https://www.yesodweb.com/book/shakespearean-templates">templating mechanisms</a> that ease the generation of HTML, CSS and Javascript for dynamic web content. The HTML templating is backed by the <a href="https://hackage.haskell.org/package/blaze-html">Blaze Html generator</a>. Thus Yesod is optimized to use <a href="https://hackage.haskell.org/package/blaze-html">Blaze</a> for HTML content. If, for example, the Blaze <code>Html</code> data type is returned from route-handlers, Yesod will automatically set the Content-Type to <code>text/html</code>.</p>
<p>So my basic idea is to use a Markdown renderer that can output Blaze <code>Html</code>-data and let Yesod do all the heavy lifting.</p>
<p>I’m using the <a href="https://hackage.haskell.org/package/cmark-gfm">cmark-gfm</a> library to render (GitHub flavoured) Markdown content to HTML. In order to output <code>Html</code>-data, my <code>renderMdToHtml</code> function has to look like follows:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">CMarkGFM</span>        (commonmarkToHtml)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Data.Text</span>       (<span class="dt">Text</span>)</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true"></a><span class="kw">import</span>           <span class="dt">Text.Blaze.Html</span> (<span class="dt">Html</span>, preEscapedToHtml)</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true"></a><span class="ot">renderMdToHtml ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Html</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true"></a>renderMdToHtml <span class="ot">=</span> preEscapedToHtml <span class="op">.</span> commonmarkToHtml [] []</span></code></pre></div>
<h2 id="inplace-content-editing">Inplace Content Editing</h2>
<h3 id="type-safe-page-names">Type safe page names</h3>
<p>In order to work with the wiki page names in a type safe manner we first introduce a newtype <code>PageName</code>. In order to make sure that only proper <a href="https://en.wikipedia.org/w/index.php?title=WikiWord">WikiWords</a> can be used as page names I’m using a <a href="https://wiki.haskell.org/Smart_constructors">smart constructor</a> <code>pageName</code> which only constructs a <code>PageName</code>instance if the intented page name matches the <code>wikiWordMatch</code> regular expression:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">PageName</span> <span class="ot">=</span> <span class="dt">Page</span> <span class="dt">Text</span> <span class="kw">deriving</span> (<span class="dt">Eq</span>, <span class="dt">Read</span>, <span class="dt">Show</span>)</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true"></a></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true"></a><span class="ot">pageName ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">PageName</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true"></a>pageName name <span class="ot">=</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true"></a>  <span class="kw">if</span> isWikiWord name</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true"></a>    <span class="kw">then</span> <span class="dt">Just</span> (<span class="dt">Page</span> name)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true"></a>    <span class="kw">else</span> <span class="dt">Nothing</span></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true"></a><span class="co">-- | checks if a given Text is a WikiWord</span></span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true"></a><span class="ot">isWikiWord ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Bool</span></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true"></a>isWikiWord pageName <span class="ot">=</span></span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true"></a>  <span class="kw">case</span> find wikiWordMatch pageName <span class="kw">of</span></span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="dt">False</span></span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true"></a>    <span class="dt">Just</span> _  <span class="ot">-&gt;</span> <span class="dt">True</span></span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true"></a></span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true"></a><span class="co">-- | the magic WikiWord Regex</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true"></a><span class="ot">wikiWordMatch ::</span> <span class="dt">Regex</span></span>
<span id="cb2-18"><a href="#cb2-18" aria-hidden="true"></a>wikiWordMatch <span class="ot">=</span> <span class="st">&quot;([A-Z][a-z0-9]+){2,}&quot;</span>    </span></code></pre></div>
<h3 id="the-yesod-routes-for-the-editor">The Yesod routes for the editor</h3>
<p>The following <code>PathPiece</code> instance declaration is required to use the <code>PageName</code> as part of a Yesod route definition:</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true"></a><span class="kw">instance</span> <span class="dt">PathPiece</span> <span class="dt">PageName</span> <span class="kw">where</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true"></a>  toPathPiece page   <span class="ot">=</span> asText page</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true"></a>  fromPathPiece text <span class="ot">=</span> pageName text</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true"></a></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true"></a><span class="ot">asText ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true"></a>asText (<span class="dt">Page</span> name) <span class="ot">=</span> name</span></code></pre></div>
<p>Again the usage of the <code>pageName</code> smart constructor ensures that only proper WikiWord pagenames are constructed.</p>
<p>Here comes the <a href="https://www.yesodweb.com/book/basics#basics_routing">Yesod route definition</a> for displaying and editing of wiki pages:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true"></a><span class="kw">newtype</span> <span class="dt">HsWiki</span> <span class="ot">=</span> <span class="dt">HsWiki</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true"></a>  {<span class="ot"> contentDir ::</span> <span class="dt">String</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true"></a>  }</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true"></a></span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true"></a>mkYesod <span class="st">&quot;HsWiki&quot;</span> [parseRoutes|</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true"></a>/#PageName      PageR     GET             -- (1)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true"></a>/edit/#PageName EditR     GET POST        -- (2)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true"></a>|]</span></code></pre></div>
<p>Definition (1) can be read as follows: for any <code>PageName</code> that is accessed via a HTTP GET a route PageR is defined, which (according to the rules of the Yesod routing DSL) requires us to implement a function with the following signature:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true"></a><span class="ot">getPageR ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Html</span></span></code></pre></div>
<p>This function will have to lookup an existing page, render its Markdown content to Html and return it a <code>Handler Html</code> object. We’ll have a look at this function shortly.</p>
<p>The definition (2) states that for any route /edit/<code>PageName</code> two functions must be defined, one for GET one for POST:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true"></a><span class="ot">getEditR  ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true"></a><span class="ot">postEditR ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Html</span></span></code></pre></div>
<p>If you want to know how exactly handler function are invoked from the Yesod framework and how the route dispatching works, please have a look at the excellent <a href="https://www.yesodweb.com/book/">Yesod documentation</a> which features a complete walkthrough with a HelloWorld application.</p>
<h3 id="serving-an-editor">Serving an editor</h3>
<p>Now let’s study the implementation of these two function step by step, first the GET handler:</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true"></a><span class="co">-- | handler for GET /edit/#PageName</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true"></a><span class="ot">getEditR ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true"></a>getEditR pageName <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true"></a>  path <span class="ot">&lt;-</span> getDocumentRoot                    <span class="co">-- obtain path to document root </span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true"></a>  <span class="kw">let</span> fileName <span class="ot">=</span> fileNameFor path pageName   <span class="co">-- construct a file from the page name</span></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true"></a>  exists <span class="ot">&lt;-</span> liftIO <span class="op">$</span> doesFileExist fileName  <span class="co">-- check whether file already exists</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true"></a>  markdown <span class="ot">&lt;-</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true"></a>    <span class="kw">if</span> exists</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true"></a>      <span class="kw">then</span> liftIO <span class="op">$</span> TIO.readFile fileName    <span class="co">-- if file exists, assign markdown with file content</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true"></a>      <span class="kw">else</span> <span class="fu">return</span> newPage                    <span class="co">-- else assign markdown with default content</span></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true"></a>  <span class="fu">return</span> <span class="op">$</span> buildEditorFor pageName markdown  <span class="co">-- return Html for an Editor page</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true"></a></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true"></a><span class="co">-- | retrieve the name of the HsWiki {contentDir} attribute, defaults to 'content'</span></span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true"></a><span class="ot">getDocumentRoot ::</span> <span class="dt">Handler</span> <span class="dt">String</span></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true"></a>getDocumentRoot <span class="ot">=</span> getsYesod contentDir  </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true"></a></span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true"></a><span class="co">-- | construct the proper file name for a PageName</span></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true"></a><span class="ot">fileNameFor ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">PageName</span>  <span class="ot">-&gt;</span> <span class="dt">FilePath</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true"></a>fileNameFor path pageName <span class="ot">=</span> path <span class="op">++</span> <span class="st">&quot;/&quot;</span> <span class="op">++</span> asString pageName <span class="op">++</span> <span class="st">&quot;.md&quot;</span></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true"></a><span class="co">-- | create default content for a new page</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true"></a><span class="ot">newPage ::</span> <span class="dt">Text</span></span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true"></a>newPage <span class="ot">=</span></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true"></a>     <span class="st">&quot;Use WikiWords in PascalCase for Links. \n\n&quot;</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true"></a>  <span class="op">&lt;&gt;</span> <span class="st">&quot;Use [Markdown](https://github.com/adam-p/markdown-here/wiki/Markdown-Cheatsheet) to format page content&quot;</span></span></code></pre></div>
<p>As we can see from the reading of markdown content from files, the idea is to just keep all pages as static content files in the filesystem. By default these files reside in the local folder <em>content</em> (this folder can be configured by a commandline argument).</p>
<p>Next we’ll have a look at the <code>buildEditorFor</code> function that will generate the actual Html content of the editor page:</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true"></a><span class="ot">buildEditorFor ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Html</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true"></a>buildEditorFor pageName markdown <span class="ot">=</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true"></a>  toHtml</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true"></a>    [ pageHeader <span class="dt">False</span>,</span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true"></a>      menuBar <span class="st">&quot;&quot;</span>,</span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true"></a>      renderMdToHtml <span class="op">$</span> <span class="st">&quot;# &quot;</span> <span class="op">&lt;&gt;</span> page <span class="op">&lt;&gt;</span> <span class="st">&quot; \n&quot;</span>,</span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true"></a>      preEscapedToHtml <span class="op">$</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true"></a>        <span class="st">&quot;&lt;form action=\&quot;&quot;</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true"></a>          <span class="op">&lt;&gt;</span> page</span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true"></a>          <span class="op">&lt;&gt;</span> <span class="st">&quot;\&quot; method=\&quot;POST\&quot;&gt;&quot;</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true"></a>          <span class="op">&lt;&gt;</span> <span class="st">&quot;&lt;textarea style=\&quot;height: auto;\&quot; name=\&quot;content\&quot; cols=\&quot;120\&quot; rows=\&quot;25\&quot;&gt;&quot;</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true"></a>          <span class="op">&lt;&gt;</span> markdown</span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true"></a>          <span class="op">&lt;&gt;</span> <span class="st">&quot;&lt;/textarea&gt;&quot;</span></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true"></a>          <span class="op">&lt;&gt;</span> <span class="st">&quot;&lt;input type=\&quot;submit\&quot; name=\&quot;save\&quot; value=\&quot;save\&quot; /&gt; &amp;nbsp; &quot;</span></span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true"></a>          <span class="op">&lt;&gt;</span> <span class="st">&quot;&lt;input class=\&quot;button button-outline\&quot; type=\&quot;button\&quot; name=\&quot;cancel\&quot; value=\&quot;cancel\&quot; onClick=\&quot;window.history.back()\&quot; /&gt; &quot;</span></span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true"></a>          <span class="op">&lt;&gt;</span> <span class="st">&quot;&lt;/form&gt;&quot;</span>,</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true"></a>      pageFooter</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true"></a>    ]</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true"></a>  <span class="kw">where</span> page <span class="ot">=</span> asText pageName</span></code></pre></div>
<p>The most important element here is the creation of an Html <code>&lt;form ...&gt;...&lt;/form&gt; element. The action for that form is just the same page but with a</code>POST<code>-method (we'll come to the respective handler function</code>postEditR` shortly).</p>
<p>Now imagine we point our browser to <code>http://localhost:3000/edit/BrandNewPage</code>. Yesod will do the routing to <code>getEditR (Page "BrandNewPage")</code> and the generated Html for editing a new page ‘BrandNewPage’ will be sent back to the browser. The page will look like this:</p>
<figure>
<img src="../img/editor.png" alt /><figcaption>The Editor for a new page</figcaption>
</figure>
<p>As we can see, I’ve applied some basic CSS styling <a href="https://milligram.io/">(using Milligram CSS)</a>. This is done in the <code>pageHeader</code> function.</p>
<h3 id="processing-the-posting-of-data">processing the posting of data</h3>
<p>The editor has two buttons, <em>SAVE</em> and <em>CANCEL</em>. On cancel we just navigate back to the previous page in the browser history. On save the browser sends the form data via the <code>POST</code> method to the server. To handle this incoming POST-request we’ll the <code>postEditR</code> handler function:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true"></a><span class="ot">postEditR ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true"></a>postEditR pageName <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true"></a>  path <span class="ot">&lt;-</span> getDocumentRoot                    <span class="co">-- obtain path to document root</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true"></a>  <span class="kw">let</span> fileName <span class="ot">=</span> fileNameFor path pageName   <span class="co">-- construct a file from the page name</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true"></a>  maybeContent <span class="ot">&lt;-</span> lookupPostParam <span class="st">&quot;content&quot;</span>  <span class="co">-- retrieve POST data</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true"></a>  client <span class="ot">&lt;-</span> remoteHost <span class="op">&lt;$&gt;</span> waiRequest        <span class="co">-- retrieve info on remote client from request</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true"></a>  <span class="kw">case</span> maybeContent <span class="kw">of</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true"></a>    <span class="dt">Just</span> content <span class="ot">-&gt;</span> liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true"></a>      TIO.writeFile fileName content         <span class="co">-- if content exists write it to disk</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true"></a>      writeLogEntry path pageName client     <span class="co">-- also write a log entry to file RecentChanges</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> ()                     <span class="co">-- no content: do nothing</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true"></a>  redirect <span class="op">$</span> <span class="dt">PageR</span> pageName                  <span class="co">-- redirect to GET Page route (display content)</span></span></code></pre></div>
<p>So essentially we are just writing the markdown content into a file. After that we redirect to the <code>PageR</code> route. This will result in redirecting the browser to <code>http://localhost:3000/BrandNewPage</code>. As you can see in the following screen-shot the markdown content that was entered in the editor form is now rendered as HTML:</p>
<figure>
<img src="../img/renderPage.png" alt /><figcaption>render an existing page</figcaption>
</figure>
<h3 id="rendering-page-content">rendering page content</h3>
<p>As promised above we’ll now have a closer look at the <code>getPageR</code> route handler function:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true"></a><span class="co">-- | Handler for GET /#PageName</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true"></a><span class="ot">getPageR ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true"></a>getPageR pageName <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true"></a>  path <span class="ot">&lt;-</span> getDocumentRoot                            <span class="co">-- obtain path to document root </span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true"></a>  maybeShowRefs <span class="ot">&lt;-</span> lookupGetParam <span class="st">&quot;showBackrefs&quot;</span>     <span class="co">-- check whether URL ends with '?showBackrefs'</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true"></a>  maybeBackrefs <span class="ot">&lt;-</span> liftIO <span class="op">$</span>                          <span class="co">-- if showBackrefs was set, Just [PageName] </span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true"></a>    computeMaybeBackrefs path pageName maybeShowRefs <span class="co">-- else Nothing</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true"></a>  <span class="kw">let</span> fileName <span class="ot">=</span> fileNameFor path pageName           <span class="co">-- compute proper filename from pageName</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true"></a>  exists <span class="ot">&lt;-</span> liftIO <span class="op">$</span> doesFileExist fileName          <span class="co">-- check whether such a file exists</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true"></a>  <span class="kw">if</span> exists</span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true"></a>    <span class="kw">then</span> <span class="kw">do</span>                                                                  </span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true"></a>      content <span class="ot">&lt;-</span> liftIO <span class="op">$</span> TIO.readFile fileName      <span class="co">-- file exists, read its content</span></span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true"></a>      <span class="fu">return</span> <span class="op">$</span> buildViewFor </span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true"></a>        pageName content maybeBackrefs               <span class="co">-- build HTML for content and return it</span></span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true"></a>    <span class="kw">else</span> <span class="kw">do</span></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true"></a>      redirect <span class="op">$</span> <span class="dt">EditR</span> pageName                      <span class="co">-- file does not exist, redirect to EditR</span></span></code></pre></div>
<p>Let’s ignore the lines with <code>maybeShowRefs</code> and <code>maybeBackrefs</code> for a moment. We just assume that <code>maybeBackrefs == Nothing</code>. So we first check whether a file exists for the given <code>pageName</code>. If yes, the file-content is read and bound to <code>content</code>; next we build a HTML view for the page with <code>buildViewFor</code> and return it. If no file was found matching <code>pageName</code> we redirect directly to the <code>EditR</code>which will in turn open up an editor for an empty page as already shown in the previous section.</p>
<p>Let’s have a closer look at <code>buildViewFor</code>. It will first evaluate the <code>maybeBackrefs</code> arguments. For the moment let’s assume equals <code>Nothing</code>, so that <code>hasBackref</code> is bound to <code>True</code> and <code>backrefEntry</code> to <code>""</code>.</p>
<p>Then the actual HTML for the page is constructed from a set of template functions: - <code>pageHeader</code> creates the HTML head with css definitions, - <code>menuBar</code> creates the menu line on top of the page, - <code>pageTitle</code> creates a headline from the <code>pageName</code>, - <code>backrefEntry</code> is just empty text in this scenario - <code>renderMdToHtml (wikiWordToMdLink content)</code> first replaces all ocurrences of <em>WikiWords</em> with proper Markdown hyperlinks of the form <code>[WikiWord](WikiWord)</code> the result is then rendered to HTML (this is the single place where we convert from <em>WikiWords</em> to hyperlinks and thus make the Wiki magic happen…), - finally <code>pageFooter</code> closes all open html tags:</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true"></a><span class="ot">buildViewFor ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [<span class="dt">PageName</span>] <span class="ot">-&gt;</span> <span class="dt">Html</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true"></a>buildViewFor pageName content maybeBackrefs <span class="ot">=</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true"></a>  <span class="kw">let</span> (hasBackref, backrefEntry) <span class="ot">=</span> <span class="kw">case</span> maybeBackrefs <span class="kw">of</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true"></a>        <span class="dt">Nothing</span>       <span class="ot">-&gt;</span> (<span class="dt">False</span>, text <span class="st">&quot;&quot;</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true"></a>        <span class="dt">Just</span> backrefs <span class="ot">-&gt;</span> (<span class="dt">True</span>, renderedBackrefs)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true"></a>          <span class="kw">where</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true"></a><span class="ot">            concatMap ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true"></a>            <span class="fu">concatMap</span> <span class="ot">=</span> (T.intercalate <span class="st">&quot;&quot;</span> <span class="op">.</span>) <span class="op">.</span> <span class="fu">map</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true"></a>            renderedBackrefs <span class="ot">=</span> renderMdToHtml <span class="op">$</span> <span class="fu">concatMap</span> ((\b <span class="ot">-&gt;</span> <span class="st">&quot;- [&quot;</span> <span class="op">&lt;&gt;</span> b <span class="op">&lt;&gt;</span> <span class="st">&quot;](/&quot;</span> <span class="op">&lt;&gt;</span> b <span class="op">&lt;&gt;</span> <span class="st">&quot;) \n&quot;</span>) <span class="op">.</span> asText) backrefs</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true"></a>   <span class="kw">in</span> toHtml [pageHeader <span class="dt">False</span>, </span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true"></a>              menuBar (asText pageName), </span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true"></a>              pageTitle pageName hasBackref, </span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true"></a>              backrefEntry, </span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true"></a>              renderMdToHtml (wikiWordToMdLink content), </span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true"></a>              pageFooter]</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true"></a></span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true"></a><span class="co">-- | converts a WikiWord into a Markdown link: [WikiWord](WikiWord)</span></span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true"></a><span class="ot">wikiWordToMdLink ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true"></a>wikiWordToMdLink text <span class="ot">=</span></span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true"></a>  <span class="kw">let</span> match <span class="ot">=</span> wikiWordMatch</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true"></a>      replace <span class="ot">=</span> <span class="st">&quot;[$0]($0)&quot;</span></span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true"></a>   <span class="kw">in</span> replaceAll match replace text              </span></code></pre></div>
<h2 id="displaying-back-links-aka-reverse-index-for-each-page">Displaying back links (aka reverse index) for each page</h2>
<p>Another important feature of the original WikiWiki was the seamless integration of back links:</p>
<blockquote>
<p>If page A links to page B, then a ‘back link’ would be a link which goes from page B back to page A.</p>
<p>On this wiki, the title of each page works as a back link. Clicking on the title of any page finds all the pages referring to that page. It works for any wiki page. E.g. to find all pages that link to this page, click the title at the top of this page.</p>
<p><a href="http://wiki.c2.com/?BackLink">quoted from the WikiWiki</a></p>
</blockquote>
<p>This feature can best be demonstrated with an example. First we lookup up page <code>http://localhost:3000/CategoryMammal</code>, a page meant to represent the class of all mammaĺ animals:</p>
<figure>
<img src="../img/CategoryMammal.png" alt /><figcaption>normal view of a category page</figcaption>
</figure>
<p>The headline of this page is a hyperlink which references <code>http://localhost:3000/CategoryMammal?showBackrefs</code>. Following the link results in the following page:</p>
<figure>
<img src="../img/CategoryMammalWithBackLinks.png" alt /><figcaption>the category page with the listing of back references</figcaption>
</figure>
<p>Now we see a bullet point list of all pages linking to <em>CategoryMammal</em> above the normal page content. Following one of these links, e.g. <code>http://localhost:3000/SpeciesCat</code>, leads to the following page:</p>
<figure>
<img src="../img/SpeciesCat.png" alt /><figcaption>a wiki page referencing to the category page</figcaption>
</figure>
<p>At the bottom of this page we see the <em>WikiWord</em> CategoryMammal. This is interpreted as a link from <em>SpeciesCat</em> to <em>CategoryMammal</em>. And as a result the back-link display on page <em>CategoryMammal</em> contains a link to <em>SpeciesCat</em>.</p>
<p>Let’s see how this works on the code level. In fact we already came across this mechanism but had skipped over it for the time being. Now it’s time to revisit. We start with the <code>getPageR</code> function.</p>
<p>In our scenario a click on the link <code>http://localhost:3000/CategoryMammal?showBackrefs</code> leads to a call to <code>getPageR</code>. But this time <code>lookupGetParam "showBackrefs"</code> will succeed and thus now <code>maybeShowRefs</code> is bound to <code>Just ""</code>. This will lead to a different execution path in the call to <code>computeMaybeBackrefs</code>:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true"></a><span class="co">-- | Handler for GET /#PageName</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true"></a><span class="ot">getPageR ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true"></a>getPageR pageName <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true"></a>  path <span class="ot">&lt;-</span> getDocumentRoot                            <span class="co">-- obtain path to document root </span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true"></a>  maybeShowRefs <span class="ot">&lt;-</span> lookupGetParam <span class="st">&quot;showBackrefs&quot;</span>     <span class="co">-- check whether URL ends with '?showBackrefs'</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true"></a>  maybeBackrefs <span class="ot">&lt;-</span> liftIO <span class="op">$</span>                          <span class="co">-- if showBackrefs was set, Just [PageName] </span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true"></a>    computeMaybeBackrefs path pageName maybeShowRefs <span class="co">-- else Nothing</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true"></a>  <span class="kw">let</span> fileName <span class="ot">=</span> fileNameFor path pageName           <span class="co">-- compute proper filename from pageName</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true"></a>  exists <span class="ot">&lt;-</span> liftIO <span class="op">$</span> doesFileExist fileName          <span class="co">-- check whether such a file exists</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true"></a>  <span class="kw">if</span> exists</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true"></a>    <span class="kw">then</span> <span class="kw">do</span>                                                                  </span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true"></a>      content <span class="ot">&lt;-</span> liftIO <span class="op">$</span> TIO.readFile fileName      <span class="co">-- file exists, read its content</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true"></a>      <span class="fu">return</span> <span class="op">$</span> buildViewFor </span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true"></a>        pageName content maybeBackrefs               <span class="co">-- build HTML for content and return it</span></span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true"></a>    <span class="kw">else</span> <span class="kw">do</span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true"></a>      redirect <span class="op">$</span> <span class="dt">EditR</span> pageName                      <span class="co">-- file does not exist, redirect to EditR</span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true"></a></span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true"></a><span class="co">-- | if maybeShowRefs isJust then a list of a pages referencing pageName is computed</span></span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true"></a><span class="ot">computeMaybeBackrefs ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> (<span class="dt">Maybe</span> [<span class="dt">PageName</span>])</span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true"></a>computeMaybeBackrefs path pageName maybeShowRefs <span class="ot">=</span></span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true"></a>  <span class="kw">case</span> maybeShowRefs <span class="kw">of</span></span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="dt">Nothing</span>                      <span class="co">-- if maybeShowRefs == Nothing, return Nothing</span></span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true"></a>    <span class="dt">Just</span> _  <span class="ot">-&gt;</span> <span class="kw">do</span>                                  <span class="co">-- else compute list of all references to page by</span></span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true"></a>      allPages <span class="ot">&lt;-</span> computeIndex path                <span class="co">-- computing list of all pages in wiki</span></span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true"></a>      backrefs <span class="ot">&lt;-</span> computeBackRefs path pageName allPages <span class="co">-- compute all back references</span></span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true"></a>      <span class="fu">return</span> <span class="op">$</span> <span class="dt">Just</span> backrefs                       <span class="co">-- return this list wrapped as a Maybe</span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true"></a></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true"></a></span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true"></a><span class="co">-- | compute a list of all pages that contain references to pageName</span></span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true"></a><span class="ot">computeBackRefs ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> [<span class="dt">PageName</span>] <span class="ot">-&gt;</span> <span class="dt">IO</span> [<span class="dt">PageName</span>]</span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true"></a>computeBackRefs path pageName allPages <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true"></a>  <span class="kw">let</span> filteredPages <span class="ot">=</span> delete pageName allPages   <span class="co">-- filter pagename from list of pages</span></span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true"></a>  markRefs <span class="ot">&lt;-</span> <span class="fu">mapM</span>                               <span class="co">-- create a list of bools: True if a page contains</span></span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true"></a>    (<span class="fu">fmap</span> containsBackref <span class="op">.</span> TIO.readFile <span class="op">.</span> fileNameFor path)             <span class="co">-- a reference, else False</span></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true"></a>    filteredPages</span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true"></a>  <span class="kw">let</span> pageBoolPairs <span class="ot">=</span> <span class="fu">zip</span> filteredPages markRefs <span class="co">-- create a zipped list of (pageName, Bool) pairs</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true"></a>  <span class="fu">return</span> <span class="op">$</span> <span class="fu">map</span> <span class="fu">fst</span> (<span class="fu">filter</span> <span class="fu">snd</span> pageBoolPairs)    <span class="co">-- return only pages marked True</span></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true"></a>  <span class="kw">where</span></span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true"></a>    containsBackref content <span class="ot">=</span>                    <span class="co">-- returns True if content contains pageName</span></span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true"></a>      asText pageName <span class="ot">`T.isInfixOf`</span> content</span></code></pre></div>
<p>Next we revisit <code>buildViewFor</code>. Here we see a case match on <code>maybeBackrefs</code>. In our current scenario it will match to <code>Just backrefs</code>. Thus <code>renderedBackrefs</code> will be bound to Html generated by rendering a Markdown list of hyperlinks that is constructed from the <code>backrefs</code> list of PageNames.</p>
<p>This generated Html is then included as <code>backrefEntry</code> into the overall page layout:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true"></a><span class="ot">buildViewFor ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Maybe</span> [<span class="dt">PageName</span>] <span class="ot">-&gt;</span> <span class="dt">Html</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true"></a>buildViewFor pageName content maybeBackrefs <span class="ot">=</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true"></a>  <span class="kw">let</span> (hasBackref, backrefEntry) <span class="ot">=</span> <span class="kw">case</span> maybeBackrefs <span class="kw">of</span></span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true"></a>        <span class="dt">Nothing</span>       <span class="ot">-&gt;</span> (<span class="dt">False</span>, text <span class="st">&quot;&quot;</span>)</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true"></a>        <span class="dt">Just</span> backrefs <span class="ot">-&gt;</span> (<span class="dt">True</span>, renderedBackrefs)</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true"></a>          <span class="kw">where</span></span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true"></a><span class="ot">            concatMap ::</span> (a <span class="ot">-&gt;</span> <span class="dt">Text</span>) <span class="ot">-&gt;</span> [a] <span class="ot">-&gt;</span> <span class="dt">Text</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true"></a>            <span class="fu">concatMap</span> <span class="ot">=</span> (T.intercalate <span class="st">&quot;&quot;</span> <span class="op">.</span>) <span class="op">.</span> <span class="fu">map</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true"></a>            renderedBackrefs <span class="ot">=</span> </span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true"></a>              renderMdToHtml <span class="op">$</span> <span class="fu">concatMap</span> </span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true"></a>                  ((\b <span class="ot">-&gt;</span> <span class="st">&quot;- [&quot;</span> <span class="op">&lt;&gt;</span> b <span class="op">&lt;&gt;</span> <span class="st">&quot;](/&quot;</span> <span class="op">&lt;&gt;</span> b <span class="op">&lt;&gt;</span> <span class="st">&quot;) \n&quot;</span>) <span class="op">.</span> asText) </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true"></a>                  backrefs</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true"></a>   <span class="kw">in</span> toHtml [pageHeader <span class="dt">False</span>, </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true"></a>              menuBar (asText pageName), </span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true"></a>              pageTitle pageName hasBackref, </span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true"></a>              backrefEntry, </span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true"></a>              renderMdToHtml (wikiWordToMdLink content), </span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true"></a>              pageFooter]        </span></code></pre></div>
<h2 id="show-the-latest-creation-and-edits-to-pages">Show the latest creation and edits to pages</h2>
<p>I already covered the <code>postEditR</code> function, but I did not explain the <code>writeLogEntry</code> function which traces each change to page-content. So here comes the full picture:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true"></a><span class="ot">postEditR ::</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true"></a>postEditR pageName <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true"></a>  path <span class="ot">&lt;-</span> getDocumentRoot                    <span class="co">-- obtain path to document root</span></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true"></a>  <span class="kw">let</span> fileName <span class="ot">=</span> fileNameFor path pageName   <span class="co">-- construct a file from the page name</span></span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true"></a>  maybeContent <span class="ot">&lt;-</span> lookupPostParam <span class="st">&quot;content&quot;</span>  <span class="co">-- retrieve POST data</span></span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true"></a>  client <span class="ot">&lt;-</span> remoteHost <span class="op">&lt;$&gt;</span> waiRequest        <span class="co">-- retrieve info on remote client from request</span></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true"></a>  <span class="kw">case</span> maybeContent <span class="kw">of</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true"></a>    <span class="dt">Just</span> content <span class="ot">-&gt;</span> liftIO <span class="op">$</span> <span class="kw">do</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true"></a>      TIO.writeFile fileName content         <span class="co">-- if content exists write it to disk</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true"></a>      writeLogEntry path pageName client     <span class="co">-- also write a log entry to file RecentChanges</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true"></a>    <span class="dt">Nothing</span> <span class="ot">-&gt;</span> <span class="fu">return</span> ()                     <span class="co">-- no content: do nothing</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true"></a>  redirect <span class="op">$</span> <span class="dt">PageR</span> pageName                  <span class="co">-- redirect to GET Page route (display content)</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true"></a>  </span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true"></a><span class="co">-- | write a log entry to the RecentChanges page</span></span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true"></a><span class="ot">writeLogEntry ::</span> <span class="dt">FilePath</span> <span class="ot">-&gt;</span> <span class="dt">PageName</span> <span class="ot">-&gt;</span> <span class="dt">SockAddr</span> <span class="ot">-&gt;</span> <span class="dt">IO</span> ()</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true"></a>writeLogEntry path pageName client <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true"></a>  <span class="kw">let</span> fileName <span class="ot">=</span> fileNameFor path recentChanges <span class="co">-- path to RecentChanges page</span></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true"></a>  now <span class="ot">&lt;-</span> getCurrentTime                         <span class="co">-- create timestamp</span></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true"></a>  <span class="kw">let</span> logEntry <span class="ot">=</span> toStrict <span class="op">$</span>                     <span class="co">-- create a log entry consisting of:</span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true"></a>        format (<span class="st">&quot;- &quot;</span> <span class="op">%</span> string <span class="op">%</span> <span class="st">&quot; &quot;</span> <span class="op">%</span> string <span class="op">%</span> <span class="st">&quot; from &quot;</span> <span class="op">%</span> string <span class="op">%</span> <span class="st">&quot;\n&quot;</span>)</span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true"></a>          (asString pageName)                   <span class="co">-- page edited/created</span></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true"></a>          (<span class="fu">takeWhile</span> (<span class="op">/=</span> <span class="ch">'.'</span>) (<span class="fu">show</span> now))       <span class="co">-- current timestamp</span></span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true"></a>          (<span class="fu">takeWhile</span> (<span class="op">/=</span> <span class="ch">':'</span>) (<span class="fu">show</span> client))    <span class="co">-- IP address of client</span></span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true"></a>  TIO.appendFile fileName logEntry              <span class="co">-- add log entry at end of log file</span></span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true"></a></span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true"></a><span class="co">-- | the RecentChanges PageName</span></span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true"></a><span class="ot">recentChanges ::</span> <span class="dt">PageName</span></span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true"></a>recentChanges <span class="ot">=</span> <span class="dt">Page</span> <span class="st">&quot;RecentChanges&quot;</span></span></code></pre></div>
<p>And here comes a sample screen shot of the RecentChanges page:</p>
<figure>
<img src="../img/RecentChanges.png" alt /><figcaption>The RecentChanges page</figcaption>
</figure>
<h2 id="have-a-full-text-search">Have a full text search</h2>
<p>For the full text search Iǜe provided a specific route <code>/actions/find</code> to avoid overlap with ordinary content pages:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true"></a>mkYesod <span class="st">&quot;HsWiki&quot;</span> [parseRoutes|</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true"></a>/actions/find/  FindR     GET</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true"></a>|]</span></code></pre></div>
<p>The corresponding handler function <code>getFindR</code> is defined as follows:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true"></a><span class="co">-- | handler for GET /actions/find</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true"></a><span class="ot">getFindR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true"></a>getFindR <span class="ot">=</span> <span class="kw">do</span></span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true"></a>  path <span class="ot">&lt;-</span> getDocumentRoot                       <span class="co">-- obtain path to document root</span></span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true"></a>  allPages <span class="ot">&lt;-</span> liftIO <span class="op">$</span> computeIndex path        <span class="co">-- compute a list of all page names in wiki</span></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true"></a>  maybeSearch <span class="ot">&lt;-</span> lookupGetParam <span class="st">&quot;search&quot;</span>        <span class="co">-- check whether query param 'search' is set</span></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true"></a>  <span class="kw">case</span> maybeSearch <span class="kw">of</span></span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true"></a>    <span class="dt">Nothing</span>     <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> buildFindPage <span class="st">&quot;&quot;</span> [] <span class="co">-- if maybeSearch == Nothing or Just &quot;&quot;</span></span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true"></a>    <span class="dt">Just</span> <span class="st">&quot;&quot;</span>     <span class="ot">-&gt;</span> <span class="fu">return</span> <span class="op">$</span> buildFindPage <span class="st">&quot;&quot;</span> [] <span class="co">-- then return empty find page</span></span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true"></a>    <span class="dt">Just</span> search <span class="ot">-&gt;</span> <span class="kw">do</span>                           </span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true"></a>      markMatches <span class="ot">&lt;-</span> liftIO <span class="op">$</span>                   <span class="co">-- else create a list of Bools by</span></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true"></a>        <span class="fu">mapM</span>                                    <span class="co">-- returning True for each file that matches</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true"></a>          (\p <span class="ot">-&gt;</span> <span class="fu">fmap</span> containsSearchText <span class="op">$</span>      <span class="co">-- search, else False</span></span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true"></a>            <span class="fu">return</span> (asText p) <span class="op">&lt;&gt;</span> TIO.readFile (fileNameFor path p)) </span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true"></a>          allPages</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true"></a>      <span class="kw">let</span> pageBoolPairs <span class="ot">=</span> <span class="fu">zip</span> allPages markMatches  <span class="co">-- create a zipped list [(PageName, Bool)]</span></span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true"></a>      <span class="kw">let</span> matchingPages <span class="ot">=</span> <span class="fu">map</span> <span class="fu">fst</span> (<span class="fu">filter</span> <span class="fu">snd</span> pageBoolPairs) <span class="co">-- filter for all matching pages</span></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true"></a>      <span class="fu">return</span> <span class="op">$</span> buildFindPage search matchingPages   <span class="co">-- build find page with search term and </span></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true"></a>        <span class="kw">where</span>                                       <span class="co">-- list of matching pages</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true"></a>          containsSearchText content <span class="ot">=</span> T.toLower search <span class="ot">`T.isInfixOf`</span> T.toLower content</span></code></pre></div>
<p>The <code>buildFindPage</code> function is responsible for assembling the Html view of this page.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true"></a><span class="ot">buildFindPage ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> [<span class="dt">PageName</span>] <span class="ot">-&gt;</span> <span class="dt">Html</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true"></a>buildFindPage search pages <span class="ot">=</span> toHtml</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true"></a>  [ pageHeader <span class="dt">True</span>,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true"></a>    menuBar <span class="st">&quot;&quot;</span>,</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true"></a>    renderMdToHtml <span class="st">&quot;# FindPage &quot;</span>,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true"></a>    searchBox search,</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true"></a>    renderMdToHtml <span class="op">$</span> T.pack <span class="op">$</span> <span class="fu">concatMap</span> (\p <span class="ot">-&gt;</span> <span class="st">&quot;- [&quot;</span> <span class="op">++</span> asString p <span class="op">++</span> <span class="st">&quot;](/&quot;</span> <span class="op">++</span> asString p <span class="op">++</span> <span class="st">&quot;) \n&quot;</span>) pages,</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true"></a>    pageFooter</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true"></a>  ]</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true"></a></span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true"></a><span class="ot">searchBox ::</span> <span class="dt">Text</span> <span class="ot">-&gt;</span> <span class="dt">Html</span></span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true"></a>searchBox search <span class="ot">=</span></span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true"></a>  preEscapedToHtml <span class="op">$</span></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true"></a>    <span class="st">&quot;&lt;script type=\&quot;text/javascript\&quot;&gt;&quot;</span></span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true"></a>    <span class="op">++</span> <span class="st">&quot;function init()&quot;</span></span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true"></a>    <span class="op">++</span> <span class="st">&quot;{&quot;</span></span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true"></a>    <span class="op">++</span> <span class="st">&quot;     document.getElementById(\&quot;search\&quot;).focus();&quot;</span></span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true"></a>    <span class="op">++</span> <span class="st">&quot;}&quot;</span></span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true"></a>    <span class="op">++</span> <span class="st">&quot;&lt;/script&gt;&quot;</span></span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true"></a>    <span class="op">++</span></span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true"></a>    <span class="st">&quot;&lt;form action=\&quot;/actions/find\&quot;&quot;</span></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot; method=\&quot;GET\&quot;&gt;&quot;</span></span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;&lt;input type=\&quot;text\&quot; id=\&quot;search\&quot; name=\&quot;search\&quot; value=\&quot;&quot;</span> <span class="op">++</span> T.unpack search <span class="op">++</span> <span class="st">&quot;\&quot; &quot;</span></span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;onfocus=\&quot;this.setSelectionRange(9999, 9999)\&quot; &quot;</span></span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;onkeyup=\&quot;this.form.submit()\&quot; /&gt; &quot;</span></span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;&lt;input type=\&quot;submit\&quot; value=\&quot;find\&quot; /&gt;&quot;</span></span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;&lt;/form&gt;&quot;</span></span></code></pre></div>
<p>The only interesting thing here is that I’ve include a bit of JavaScript to enable page updates while typing into the find box. See the FindPage in action below:</p>
<figure>
<img src="../img/FindPage.png" alt /><figcaption>The FindPage</figcaption>
</figure>
<h2 id="provide-a-graph-view-of-pages-and-their-links">Provide a graph view of pages and their links</h2>
<p>So far I’ve just reimplemented stuff that was already there in the original WikiWiki. While toying around with my HsWiki I thought it might be a nice addition to have a graph representation of the site content.</p>
<p>As always I try to code as little as possible myself and get the hard work done by the experts. In this case I’m relying on my alltime favourite Graph rendering library <a href="https://graphviz.org/">GraphViz</a>. This time in it’s web assembly incarnation <a href="https://github.com/magjac/d3-graphviz">d3-graphviz</a>.</p>
<p>So again we’ll have a specific route:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true"></a>mkYesod <span class="st">&quot;HsWiki&quot;</span> [parseRoutes|</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true"></a>/actions/graph  GraphR    GET</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true"></a>|]</span></code></pre></div>
<p>And a corresponding route handler function:</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true"></a><span class="co">-- | handler for GET /actions/graph</span></span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true"></a><span class="ot">getGraphR ::</span> <span class="dt">Handler</span> <span class="dt">Html</span></span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true"></a>getGraphR <span class="ot">=</span> <span class="kw">do</span>                                    </span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true"></a>  path     <span class="ot">&lt;-</span> getDocumentRoot                     <span class="co">-- obtain document root folder</span></span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true"></a>  allPages <span class="ot">&lt;-</span> liftIO <span class="op">$</span> computeIndex path          <span class="co">-- compute list of all wiki pages</span></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true"></a>  allRefs  <span class="ot">&lt;-</span> liftIO <span class="op">$</span> <span class="fu">mapM</span>                       <span class="co">-- compute list of all back references</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true"></a>    (\p <span class="ot">-&gt;</span> computeBackRefs path p allPages)       </span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true"></a>    allPages                                      <span class="co">-- for each file in allPages</span></span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true"></a>  <span class="fu">return</span> <span class="op">$</span> buildGraphView <span class="op">$</span> <span class="fu">zip</span> allRefs allPages  <span class="co">-- return Html view for [([PageName], PageName)] graph</span></span></code></pre></div>
<p>Please note that this implementation has <span class="math inline">\(O(n^2)\)</span>. This is caused by relying on <code>computeBackrefs</code> this function traverses all files and is called once for each file by <code>mapM</code>. Improving this is left as an exercise for the interested reader (all pull requests are welcome!</p>
<p>The actual Html rendering is a bit more involved as I have to integrate the JS code for d3-graphviz and also to render the GraphViz DOT graph representation:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode haskell"><code class="sourceCode haskell"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true"></a><span class="co">-- | build view for GraphViz representation of wiki page structure</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true"></a><span class="ot">buildGraphView ::</span> [([<span class="dt">PageName</span>], <span class="dt">PageName</span>)] <span class="ot">-&gt;</span> <span class="dt">Html</span></span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true"></a>buildGraphView graph <span class="ot">=</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true"></a>  toHtml</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true"></a>    [ pageHeader <span class="dt">False</span>,</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true"></a>      menuBar <span class="st">&quot;&quot;</span>,</span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true"></a>      renderMdToHtml <span class="st">&quot;# Site Map \n&quot;</span>,</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true"></a>      renderMdToHtml <span class="st">&quot;[View as List](/actions/toc) \n&quot;</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true"></a>      preGraph,                                         <span class="co">-- load wasm scripts, begin JS script</span></span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true"></a>      preEscapedToHtml <span class="op">$</span> renderNodes <span class="op">$</span> allNodes graph,  <span class="co">-- build list of all PageName nodes</span></span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true"></a>      preEscapedToHtml <span class="op">$</span> renderGraph graph,             <span class="co">-- build link structure as directed graph</span></span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true"></a>      postGraph,                                        <span class="co">-- render DOT digraph</span></span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true"></a>      pageFooter</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true"></a>    ]</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true"></a></span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true"></a><span class="co">-- | render graph in DOT syntax (from -&gt; to;)</span></span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true"></a><span class="ot">renderGraph ::</span> [([<span class="dt">PageName</span>], <span class="dt">PageName</span>)] <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true"></a>renderGraph graph <span class="ot">=</span></span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true"></a>  <span class="fu">foldr</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true"></a>    (\str <span class="ot">-&gt;</span> ((str <span class="op">++</span> <span class="st">&quot;,\n&quot;</span>) <span class="op">++</span>))</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true"></a>    <span class="st">&quot;&quot;</span></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true"></a>    (<span class="fu">concatMap</span> (\(sources, target) <span class="ot">-&gt;</span> </span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true"></a>      <span class="fu">map</span> </span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true"></a>        (\s <span class="ot">-&gt;</span> <span class="st">&quot;'\&quot;&quot;</span> <span class="op">++</span> asString s <span class="op">++</span> <span class="st">&quot;\&quot; -&gt; \&quot;&quot;</span> <span class="op">++</span> asString target <span class="op">++</span> <span class="st">&quot;\&quot;;'&quot;</span>) </span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true"></a>        sources) </span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true"></a>      graph)</span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true"></a><span class="co">-- | extract list of unique PageNames from graph</span></span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true"></a><span class="ot">allNodes ::</span> [([<span class="dt">PageName</span>], <span class="dt">PageName</span>)] <span class="ot">-&gt;</span> [<span class="dt">PageName</span>]</span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true"></a>allNodes <span class="ot">=</span> nub <span class="op">.</span> (<span class="fu">uncurry</span> (<span class="fu">flip</span> (<span class="op">:</span>)) <span class="op">=&lt;&lt;</span>)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true"></a></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true"></a><span class="co">-- | render list of PageNames as DOT list of nodes with some nice formatting</span></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true"></a><span class="ot">renderNodes ::</span> [<span class="dt">PageName</span> ] <span class="ot">-&gt;</span> <span class="dt">String</span></span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true"></a>renderNodes <span class="ot">=</span></span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true"></a>  <span class="fu">concatMap</span></span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true"></a>    ( \n <span class="ot">-&gt;</span></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true"></a>        <span class="st">&quot;'\&quot;&quot;</span> <span class="op">++</span> asString n</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true"></a>          <span class="op">++</span> <span class="st">&quot;\&quot; [shape=\&quot;rect\&quot;, style=\&quot;rounded,filled\&quot;, fillcolor=\&quot;#f4f5f6\&quot;, fontcolor=\&quot;#9b4dca\&quot;, fontname=\&quot;Roboto\&quot;,  URL=\&quot;/&quot;</span></span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true"></a>          <span class="op">++</span> asString n</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true"></a>          <span class="op">++</span> <span class="st">&quot;\&quot;];', \n&quot;</span></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true"></a>    )</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true"></a></span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true"></a><span class="co">-- | Html with script code for loading d3-graphviz and opening the DOT digraph</span></span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true"></a><span class="ot">preGraph ::</span> <span class="dt">Html</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true"></a>preGraph <span class="ot">=</span></span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true"></a>  preEscapedToHtml <span class="op">$</span></span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true"></a>    <span class="st">&quot;&lt;script src=\&quot;//d3js.org/d3.v5.min.js\&quot;&gt;&lt;/script&gt;&quot;</span></span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;&lt;script src=\&quot;https://unpkg.com/@hpcc-js/wasm@0.3.11/dist/index.min.js\&quot;&gt;&lt;/script&gt;&quot;</span></span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;&lt;script src=\&quot;https://unpkg.com/d3-graphviz@3.0.5/build/d3-graphviz.js\&quot;&gt;&lt;/script&gt;&quot;</span></span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;&lt;div id=\&quot;graph\&quot; &gt;&lt;/div&gt;&quot;</span></span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;&lt;script&gt;&quot;</span></span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;var dot =\n&quot;</span></span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;    [\n&quot;</span></span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;        'digraph  {',\n&quot;</span></span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true"></a></span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true"></a><span class="co">-- | Html with script code for rendering the DOT digraph</span></span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true"></a><span class="ot">postGraph ::</span> <span class="dt">Html</span></span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true"></a>postGraph <span class="ot">=</span></span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true"></a>  preEscapedToHtml <span class="op">$</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true"></a>    <span class="st">&quot;        '}'\n&quot;</span></span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;     ];\n&quot;</span></span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot; \n&quot;</span></span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot; d3.select(\&quot;#graph\&quot;).graphviz()\n&quot;</span></span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot;     .renderDot(dot.join(''));\n&quot;</span></span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot; \n&quot;</span></span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true"></a>      <span class="op">++</span> <span class="st">&quot; &lt;/script&gt;\n&quot;</span></span></code></pre></div>
<p>You can see this in action in the following screen shot:</p>
<figure>
<img src="../img/SiteMap.png" alt /><figcaption>The SiteMap with a graph rendering of pages and their links</figcaption>
</figure>
<h2 id="appendix">Appendix</h2>
<h3 id="how-to-build">How to build</h3>
<pre><code>stack init
stack install
HsWiki</code></pre>
<h3 id="installation-under-windows">Installation under Windows</h3>
<p>Under Windows you will have to install the ICU library. I used the latest win64 version from https://github.com/unicode-org/icu/releases/tag/release-70-1. You’ll have to manually copy <em>.ddl and </em>.h files to the following locations:</p>
<ul>
<li>The actual lib files go to <code>C:\Users\&lt;username&gt;\AppData\Local\Programs\stack\x86_64-windows\msys2-&lt;installdate&gt;\mingw64\lib</code> Don’t forget to strip version number from the .dll files (so icuuc70.dll becomes icuuc.dll)</li>
<li>The include files go to <code>C:\Users\&lt;username&gt;\AppData\Local\Programs\stack\x86_64-windows\msys2-&lt;installdate&gt;\mingw64\include\unicode</code></li>
</ul>

</main>

<footer>
    Site proudly generated by
    <a href="http://jaspervdj.be/hakyll">Hakyll</a> | 
    Source code is available at 
    <a href="https://github.com/thma/thma.github.io">GitHub</a>
</footer>

</body>
</html>
